---
title: "Vignette Title"
author: "Vignette Author"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This is a secondary data analysis of this paper using R

The association between indwelling arterial catheters and mortality in hemodynamically stable patients with respiratory failure: A propensity score analysis. Chest, 148(6):1470â€“1476, Aug. 2015.

Association Between IAC Use and Hospital Mortality


Loading packages

```{r}
library(tidyverse)
library(knitr)
library(rstatix)
library(EpiStats)
library(gtsummary)

```

load in data

```{r}
catheter <- read.csv("full_cohort_data.csv")

head(catheter)
glimpse(catheter)
```

Let's select variables of interest: exposure = Use of IAC, outcome = death and confounders

lack of pneumonia, DNR at admission and Change in code status during ICU admission.
```{r}
variables.of.int <- catheter %>% 
  select(IAC = aline_flg, death = day_28_flg, age, sex = gender_num, 
         sofa = sofa_first, service_unit, COPD = copd_flg,
         Other.resp.D = resp_flg, CHF = chf_flg, AF = afib_flg, 
         chr.renal.D = renal_flg, chr.liver.D = liver_flg,
         coronary.D = cad_flg, stroke = stroke_flg, 
         malignancy = mal_flg, wbc = wbc_first, 
         hemoglobin = hgb_first, platelet = platelet_first,
         sodium = sodium_first, potassium = potassium_first,
         bicarbonate = tco2_first, chloride = chloride_first,
         urea = bun_first, creat = creatinine_first, po2 = po2_first,
         pco2 = pco2_first)

head(variables.of.int)

```
Let's recode categorical data to have ordered factors since the EpiStats package require ordered (1, 0) data

```{r}
#variables.of.int$IAC <- factor(variables.of.int$IAC, levels = c(1,0))
#variables.of.int$death <- factor(variables.of.int$death, levels = c(1,0))
#variables.of.int$sex <- factor(variables.of.int$sex, levels = c(0,1), 
                               #ordered = TRUE) # considering male as the reference in the model
#variables.of.int$service_unit <- factor(variables.of.int$service_unit, 
                                        ##levels = c("FICU", "MICU", "SICU"), 
                                       # ordered = TRUE)
#variables.of.int$COPD <- factor(variables.of.int$COPD, levels = c(1,0), 
                                #ordered = TRUE)
#variables.of.int$Other.resp.D <- factor(variables.of.int$Other.resp.D, 
                                        #levels = c(1,0), ordered = TRUE)
#variables.of.int$CHF <- factor(variables.of.int$CHF, levels = c(1,0), 
                               #ordered = TRUE)
#variables.of.int$AF <- factor(variables.of.int$AF, levels = c(1,0), 
                              #ordered = TRUE)
#variables.of.int$chr.renal.D <- factor(variables.of.int$chr.renal.D, 
                                       #levels = c(1,0), ordered = TRUE)
#variables.of.int$chr.liver.D <- factor(variables.of.int$chr.liver.D, 
                                       #levels = c(1,0), ordered = TRUE)
#variables.of.int$coronary.D <- factor(variables.of.int$coronary.D, 
                                      #levels = c(1,0), ordered = TRUE)
#variables.of.int$stroke <- factor(variables.of.int$stroke, 
                                  #levels = c(1,0), ordered = TRUE)
#variables.of.int$malignancy <- factor(variables.of.int$malignancy, 
                                      #levels = c(1,0), ordered = TRUE)

```

Let's get summary statistics
```{r}

```

## Unmatched Cohorts analysis

### Crude estimate of the association btw IAC and hospital mortality


Estimate calculation

```{r}
result.1 <- CS(variables.of.int, death, IAC, exact = TRUE, full = FALSE)

kable(result.1$df1, align = result.1$df1.align)
kable(result.1$df2, align = result.1$df2.align)

```

For multiple exposures in one table, we will be using the CSTable() function

```{r}
result.2 <- CSTable(variables.of.int, "death", 
        exposure = c("IAC", "sex", "COPD", "Other.resp.D", "CHF", "chr.renal.D", "AF"),
        exact = TRUE,
        sort = "rr",
        full = TRUE)
kable(result.2$df, align = result.2$align)
```

Now, let's stratify the cohort by Service unit type (MICU, SICU, FICU) using the function CSInter() 

```{r}
result.3 <- CSInter(variables.of.int, "death", "IAC", by = "service_unit", full = TRUE)

kable(result.3$df1, align = result.3$align)
kable(result.3$df2, align = result.3$align)
```

## Multivariate model (Poisson regression) to adjust for confunders

```{r}
variables.of.int %>% head()
model.1 <- glm(death ~ IAC + age + sex + sofa + service_unit + COPD + Other.resp.D + CHF + AF + chr.renal.D + chr.liver.D + coronary.D + stroke + malignancy + wbc + hemoglobin + platelet + sodium + potassium + bicarbonate + chloride + urea + creat + po2 + pco2, variables.of.int, family = poisson(link = "log"))

summary(model.1)
anova(model.1)

kable(round(exp(cbind(RR = coef(model.1), confint(model.1))), 3), align = "c")
round(exp(cbind(RR = coef(model.1), confint(model.1))), 3) 

tbl_regression(model.1, exponentiate = TRUE)

```

Assumption check
```{r}

```








